<html>

<head>
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
	<script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>

	<script src="../webpd.js"></script>
	<script src="../utils.js"></script>
	<script src="../github.js"></script>

	<style>
	.field{
		vertical-align: top;
	}
	.field label{
		vertical-align: top;
		display:inline-block; 
		width:220px;
		padding-top: 4px;
	}
	.field input{
		vertical-align: top;
		display:inline-block;
	}
	#panelDetails{
		padding: 15px;
	}
	#panelDetails div.field{
		padding-top: 5px;
		padding-bottom: 5px;
		border-bottom: 1px solid #777;
	}
	.subfield{
		margin-left: 245px;
	}
	</style>
</head>

<body style="background-color: 0; margin: 0; padding: 0; font-family: Verdana; font-size: 10px">

<canvas id="canvas" width="1000" height="500" draggable="false"></canvas>

<div style="position: fixed; top: 0; right: 0; opacity: 0.9; background-color: 0; color: #fff">
	<div class="field">
		<i class="fa fa-github fa-2x"></i>
		<i class="fa fa-user fa-2x"></i>
		<input id="ghAccount" type="text" placeholder="enter a github account">
		<br/>
		<i class="fa fa-github fa-2x"></i>
		<i class="fa fa-git-square fa-2x"></i>
		<select id="optRepo" placeholder="select a repository"></select>
	</div>
	<div class="field">
		<i class="fa fa-github fa-2x"></i>
		<i class="fa fa-cloud-download fa-2x"></i>
		<label>Github download (<span id="ghStats"></span>)</label>
		<button id="playPauseButton" class="fa fa-pause-circle fa-2x">
	</div>
	<div class="field">
		<i class="fa fa-github fa-2x"></i>
		<i class="fa fa-lock fa-2x"></i>
		<input id="ghUser" type="text" placeholder="github user name">
		<input id="ghPass" type="password" placeholder="github password">
		<button id="ghConnect" class="fa fa-sign-in fa-2x">
	</div>
	<div class="field">
		<i class="fa fa-clock-o fa-2x"></i>
		<label>Playback</label>
		<input id="speedSlider" type="range" min="1" max="1000" value="250">
	</div>
</div>

<script>
var canvas = document.getElementById("canvas")
var ctx = canvas.getContext("2d");

var gh = new Github()
gh.onStats(function()
{
	$('#ghStats').text(downloadCount + " : " + gh.requestsRemaining + " / " + gh.requestsLimit)
})

var speed = 0.25

var downloading = true

$(function() {
	$.get('patch.pd', function(patchStr) {
	  patch = Pd.loadPatch(patchStr)
	  Pd.start()
	})
});

$('#ghConnect').on('click', function () {
	gh.username = $('#ghUser')[0].value
	gh.password = $('#ghPass')[0].value
});

$('#speedSlider').on('change', function () {
	speed = this.value / 1000
});

$('#playPauseButton').on('click', function () {
	downloading = !downloading
	$(this).removeClass('fa-play-circle')
	$(this).removeClass('fa-pause-circle')
	$(this).addClass(downloading ? 'fa-pause-circle' : 'fa-play-circle')
	fetchCommits()
});

$('#ghAccount').on('change', function () {
	gh.searchUserRepositories(this.value, {}, function(data, meta){
		var options = $("#optRepo");
		options.empty()
		options.append($("<option />").val('').text(''));
		$.each(data.items, function() {
		    options.append($("<option />").val(this.name).text(this.name));
		});	
	})
});

$('#optRepo').on('change', function () {
	direction = {
		next: "https://api.github.com/repos/" + $('#ghAccount')[0].value + "/" + $('#optRepo')[0].value + "/commits"
	}
	// TODO clear viz !
	fetchCommits()
	relTime = 0
	index = 0
	commitsFlow = []
});


commitsBySHA = {}

commitsFlow = []



var direction = {
}

var downloadTimer = null

function fetchCommits()
{
	window.clearTimeout(downloadTimer)
	downloadTimer = null
	if(downloading)
	{
		downloadCount += 1
		gh.get(direction.next, receiveCommits)
	}
}

var downloadCount = 0
function receiveCommits(commits, meta)
{
	direction = meta

	if(direction.next)
	{
		if(downloadTimer == null)
		{
			downloadTimer = window.setTimeout(fetchCommits, 1000)
		}
	}

	for(var i in commits)
	{
		commit = commits[i]
		c = {index: commitsFlow.length, sha: commit.sha, parents: commit.parents, id: commit.author.id, message: commit.commit.message, author: commit.commit.author.name, date: new Date(commit.commit.author.date)}
		commitsFlow.push(c)
		commitsBySHA[commit.sha] = c
	}
  	

	// recompute layout : 
	var commitsByLevel = [] 

	for(var i in commitsFlow)
	{
		c = commitsFlow[commitsFlow.length - 1 - i]

		var rowMax = 0
		var links = []
		for(var p in c.parents)
		{
			var shaP = c.parents[p].sha
			var cp = commitsBySHA[shaP]
			var row = 0
			while(row < commitsByLevel.length)
			{
				if(commitsByLevel[row][0].sha == shaP)
					break
				row += 1
			}
			if(row < commitsByLevel.length)
			{
				commitsByLevel[row].unshift(c)
			}
			else
			{
				commitsByLevel.push([c])
			}
			if(row > rowMax) rowMax = row
			if(cp) links.push({row: cp.row, date: cp.date, index: cp.index})
		}

		var a = 0
		var ccount = 0
		var commiters = {}
		if(commiters[c.id])
		{
			a = commiters[c.id]
		}
		else
		{
			a = commiters[c.id] = ccount++
		}

		c.display = {index: i, row: rowMax, col: commitsByLevel[rowMax].length, author: a}
	}


}




var prev = null
var index = 0

var mainloop = function() {
    drawGame();
};
window.requestAnimationFrame( mainloop );

var relTime = 0


function drawGame()
{
	relTime += speed * 1000

	pos = Math.floor(relTime / 1000)

	var ratio = 0.003

	ctx.fillStyle = "rgb(0,0,0)";
	ctx.setTransform(1,0,0,1,0,0);
	ctx.fillRect(0, 0, canvas.width, canvas.height);

	ctx.fillStyle = "orange";
	ctx.strokeStyle = "red";
	ctx.lineWidth = 1;

	var h = canvas.height * 0.9
	var w = canvas.width

	ctx.beginPath()
	ctx.moveTo(0, h);
	ctx.lineTo(w, h);
	ctx.stroke()

	// console.log(commitsFlow.length)
	for(var i in commitsFlow)
	{
		dia = 10
		off = 2
		// if(i * (dia + off) > canvas.width) break 

		c = commitsFlow[commitsFlow.length - 1 - i]

		/*
		var rowMax = 0
		
		*/

		colors = ["rgb(255,0,0)", "rgb(0,0,255)"]

		ctx.strokeStyle = c.id == commitsFlow[0].id ? colors[0] : colors[1];
		ctx.fillStyle = c.id == commitsFlow[0].id ? colors[0] : colors[1];
		if(i == index) ctx.fillStyle = "rgb(0,255,0)"

			

		// TODO find row :
		// if have parents then loop :
		// if parent is last in row then ok
		// else if last in next row before parent then ok for this one
		// draw at max row
		
/*
		for(var j in links)
		{
			var link = links[j]
			var px = link.index * (dia + off) //-(link.date - commitsFlow[0].date) * ratio / 60000
			ctx.beginPath()
			ctx.moveTo(i * (dia + off), 10 + rowMax * (dia + off));
			ctx.lineTo(px, 10 + rowMax * (dia + off));
			ctx.lineTo(px, 10 + link.row * (dia + off));
			ctx.stroke()

		}
		*/
		ctx.beginPath()
		ctx.arc(c.display.index * (dia + off), 10 + c.display.row * (dia + off), dia/2, 0, Math.PI * 2)
		ctx.fill()


		



	}

	if(pos >= index && index < commitsFlow.length)
	{
		c = commitsFlow[commitsFlow.length - 1 - index]
		Pd.send("commit", [c.display.row, c.display.author])
		index += 1
	}



	window.requestAnimationFrame( mainloop );
}

</script>

</body>


</html>




